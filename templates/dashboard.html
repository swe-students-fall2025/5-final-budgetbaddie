{% extends "base.html" %}
{% block content %}

<header class="main-header">
    <div class="header-left">
        <div class="logo">
            <div class="logo-icon">$</div>
            <span class="logo-text">Budget Baddie</span>
        </div>
        <span class="user-email">{{ user.email }}</span>
    </div>
    
    <div class="header-right">
        <a href="{{ url_for('logout') }}" class="logout-btn">
            <img src="{{ url_for('static', filename='logout.png') }}" alt="Logout">
        </a>
    </div>
</header>

<nav class="main-nav">
    <a href="{{ url_for('dashboard') }}" class="nav-tab active">
        Dashboard
    </a>
    <a href="#" class="nav-tab">
        Plans
    </a>
    <a href="#" class="nav-tab">
        Expenses
    </a>
</nav>

<main class="main-content">
    <div class="page-header">
        <h1 class="page-title">Dashboard</h1>
        <div class="date-selector">
            <select class="date-dropdown" id="month-selector">
                <option value="1">January 2025</option>
                <option value="2">February 2025</option>
                <option value="3">March 2025</option>
                <option value="4">April 2025</option>
                <option value="5">May 2025</option>
                <option value="6">June 2025</option>
                <option value="7">July 2025</option>
                <option value="8">August 2025</option>
                <option value="9">September 2025</option>
                <option value="10">October 2025</option>
                <option value="11" selected>November 2025</option>
                <option value="12">December 2025</option>
            </select>
        </div>
    </div>

    <section class="card budget-card">
        <div class="card-header">
            <div>
                <h2 class="card-title">Monthly Budget</h2>
                <p class="card-subtitle" id="budget-month-display">November 2025</p>
            </div>
            <button id="open-budget-modal" class="icon-button">
                <img src="{{ url_for('static', filename='budget.png') }}" alt="Budget">
            </button>
        </div>
        
        <div id="budget-display-area" class="budget-display">
            <div class="empty-state">
                <p class="empty-state-text">No budget set for this month</p>
                <button class="btn-primary" id="set-budget-btn">
                    <span class="btn-icon">+</span>
                    Set Monthly Budget
                </button>
            </div>
        </div>
    </section>

    <section class="card">
        <div class="period-tabs">
            <button class="period-tab active">Daily</button>
            <button class="period-tab">Weekly</button>
            <button class="period-tab">Monthly</button>
            <button class="period-tab">Yearly</button>
        </div>
    </section>

    <section class="card">
        <h2 class="card-title" id="spending-trend-title">Monthly Spending Trend</h2>
        <div id="spending-chart" class="chart-container">
            <div class="empty-state">
                <p class="empty-state-text">No data available yet</p>
            </div>
        </div>
    </section>

    <div class="charts-grid">
        <section class="card">
            <h2 class="card-title">Spending by Category</h2>
            <div class="chart-container">
                <canvas id="expensePieChart" style="display: none;"></canvas>
                <div id="pie-chart-empty" class="empty-state">
                    <p class="empty-state-text">No expenses yet</p>
                </div>
            </div>
        </section>
        
        <section class="card">
            <h2 class="card-title">Planned vs Actual by Category</h2>
            <div class="chart-container">
                <canvas id="plannedActualChart" style="display: none;"></canvas>
                <div id="bar-chart-empty" class="empty-state">
                    <p class="empty-state-text">No data yet</p>
                </div>
            </div>
        </section>
    </div>

</main>

<button class="fab">
    <span class="fab-icon">+</span>
</button>

<div id="budget-modal" class="modal {% if need_budget_popup %}show{% endif %}">
    <div class="modal-content">
        <h3 class="modal-title">
            Budget for {{ current_month }}/{{ current_year }}
        </h3>

        <form id="budget-form" method="POST" action="{{ url_for('save_budget_plan') }}">
            <input type="hidden" name="year" value="{{ current_year }}">
            <input type="hidden" name="month" value="{{ current_month }}">
            <input type="hidden" name="categories_json" id="categories-json">

            <div class="form-group">
                <label>Category</label>
                <select id="category-select" class="form-input" {% if not can_edit_budget %}disabled{% endif %}>
                    <option value="" disabled selected>Choose existing category</option>
                    <option value="Rent">Rent</option>
                    <option value="Groceries">Groceries</option>
                    <option value="Transport">Transport</option>
                    <option value="Entertainment">Entertainment</option>
                    <option value="New">+ New category...</option>
                </select>

                <input
                    type="text"
                    id="new-category-input"
                    class="form-input"
                    placeholder="New category name"
                    style="display:none; margin-top: 10px;"
                    {% if not can_edit_budget %}disabled{% endif %}
                >
            </div>

            <div class="form-group">
              <label>Amount for this category</label>
                <div class="input-with-button">
                    <input
                        type="number"
                        step="0.01"
                        id="category-amount-input"
                        class="form-input no-spinners"
                        placeholder="0.00"
                        {% if not can_edit_budget %}disabled{% endif %}
                    >
                    <button
                        type="button"
                        id="add-category-btn"
                        class="btn-secondary"
                        {% if not can_edit_budget %}disabled{% endif %}
                    >
                        Add to plan
                    </button>
                </div>
              <div id="category-add-error" style="display: none; color: #dc3545; font-size: 0.85rem; margin-top: 5px;"></div>
            </div>

            <div class="form-group">
                <label>Current category budgets</label>
                <div class="table-container">
                    <table id="category-table" class="budget-table">
                        <thead>
                            <tr>
                                <th>Category</th>
                                <th>Amount</th>
                                {% if can_edit_budget %}
                                <th>Actions</th>
                                {% endif %}
                            </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="form-group">
                <label>Total monthly budget</label>
                
                <div class="input-with-button">
                    <input
                        type="number"
                        step="0.01"
                        name="total_budget"
                        id="total-budget-input"
                        class="form-input no-spinners"
                        placeholder="e.g. 3000.00"
                        value="{{ plan.total_budget if plan else '' }}"
                        {% if not can_edit_budget %}disabled{% endif %}
                    >
                    <button
                        type="button"
                        id="set-total-btn"
                        class="btn-secondary"
                        {% if not can_edit_budget %}disabled{% endif %}
                    >
                        Set
                    </button>
                </div>

                <small class="form-hint" style="margin-bottom: 10px; display:block;">Click "Set" to calculate Extra funds.</small>
                <div id="budget-error-message" class="budget-error-message" style="display: none; margin-bottom: 10px;">
                    Total budget cannot be less than the sum of all categories.
                </div>

                {% if can_edit_budget %}
                <button
                    type="button"
                    id="lock-total-budget-btn"
                    class="btn-secondary"
                    style="width: 100%; border: 1px dashed var(--color-border);"
                >
                    Lock Budget (Permanent)
                </button>
                {% endif %}
            </div>

            <div class="lock-warning-message" id="lock-warning" style="display: none;">
                 <strong>WARNING:</strong> Once you lock the total budget, you cannot unlock it or change the amount. You can still add categories as long as they don't exceed the total.
            </div>

            <div class="modal-buttons">
                <button type="submit" class="btn-primary">Save</button>
                <button type="button" id="close-budget-modal" class="btn-secondary">Cancel</button>
            </div>
        </form>
    </div>
</div>

<!-- Chart.js from CDN - Load FIRST before any chart code -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<!-- All existing JS code -->
<script>
document.addEventListener("DOMContentLoaded", function () {
  // ====== Modal open / close ======
  const modal = document.getElementById("budget-modal");
  const openBtn = document.getElementById("open-budget-modal");
  const closeBtn = document.getElementById("close-budget-modal");

  function openModal() {
    if (modal) modal.classList.add("show");
  }
  function closeModal() {
    if (modal) modal.classList.remove("show");
  }

  if (openBtn) {
    openBtn.addEventListener("click", openModal);
  }
  if (closeBtn) {
    closeBtn.addEventListener("click", closeModal);
  }
  if (modal) {
    modal.addEventListener("click", function (event) {
      if (event.target === modal) {
        closeModal();
      }
    });
  }

  // ====== Budget categories logic ======
  const categorySelect      = document.getElementById("category-select");
  const newCategoryInput    = document.getElementById("new-category-input");
  const categoryAmountInput = document.getElementById("category-amount-input");
  const addCategoryBtn      = document.getElementById("add-category-btn");
  const categoryTableBody   = document.querySelector("#category-table tbody");
  const totalBudgetInput    = document.getElementById("total-budget-input");
  const categoriesJsonInput = document.getElementById("categories-json");
  const budgetForm          = document.getElementById("budget-form");

  let categories = [];
  let totalEditedManually = false;
  let editingIndex = null;

  // 从后端加载已有的 category_budgets
  const initialCategoryBudgets = {{ plan.category_budgets | default({}) | tojson }};

  for (const [name, amount] of Object.entries(initialCategoryBudgets)) {
    categories.push({
      category: name,
      amount: Number(amount) || 0
    });
  }

  // 下拉选择“New” → 显示输入框
  if (categorySelect) {
    categorySelect.addEventListener("change", function () {
      if (this.value === "New") {
        newCategoryInput.style.display = "inline-block";
        newCategoryInput.focus();
      } else {
        newCategoryInput.style.display = "none";
      }
    });
  }

  // 添加 / 更新 category
    if (addCategoryBtn) {
    addCategoryBtn.addEventListener("click", function () {
      const amountValue = parseFloat(categoryAmountInput.value);

      if (isNaN(amountValue) || amountValue <= 0) {
        alert("Please enter a valid positive amount.");
        return;
      }

      let categoryName;

      if (editingIndex !== null) {
        // ✏️ 编辑状态：只改金额，不改类别
        categoryName = categories[editingIndex].category;
        categories[editingIndex].amount = amountValue;

        // 结束编辑，恢复输入控件
        editingIndex = null;
        if (categorySelect) {
          categorySelect.disabled = false;
          categorySelect.value = "";
        }
        if (newCategoryInput) {
          newCategoryInput.disabled = false;
          newCategoryInput.value = "";
          newCategoryInput.style.display = "none";
        }
      } else {
        // ➕ 新增状态：需要一个类别
        if (categorySelect.value === "New") {
          categoryName = newCategoryInput.value.trim();
        } else {
          categoryName = categorySelect.value;
        }

        if (!categoryName) {
          alert("Please choose or enter a category name.");
          return;
        }

        const existing = categories.find(c => c.category === categoryName);
        if (existing) {
          existing.amount = amountValue;
        } else {
          categories.push({ category: categoryName, amount: amountValue });
        }

        // 清理类别输入
        if (categorySelect) categorySelect.value = "";
        if (newCategoryInput) {
          newCategoryInput.value = "";
          newCategoryInput.style.display = "none";
        }
      }

      // 清理金额输入
      categoryAmountInput.value = "";

      renderCategoryTable();
      updateTotalIfNotEdited();
    });
  }


  function renderCategoryTable() {
    if (!categoryTableBody) return;
    categoryTableBody.innerHTML = "";

    categories.forEach((item, index) => {
      const tr = document.createElement("tr");

      const tdName = document.createElement("td");
      tdName.textContent = item.category;

      const tdAmount = document.createElement("td");
      tdAmount.textContent = item.amount.toFixed(2);

      tr.appendChild(tdName);
      tr.appendChild(tdAmount);

      {% if can_edit_budget %}
      // Actions: Edit / Delete
      const tdActions = document.createElement("td");

      // Edit button
      const editBtn = document.createElement("button");
      editBtn.type = "button";
      editBtn.className = "icon-button edit-btn";
      const editImg = document.createElement("img");
      editImg.src = "{{ url_for('static', filename='edit.png') }}";
      editImg.alt = "Edit";
      editBtn.appendChild(editImg);

      editBtn.addEventListener("click", function () {
        editingIndex = index;
        if (categoryAmountInput) {
          categoryAmountInput.value = item.amount.toFixed(2);
        }
        // 不允许在编辑中改 category 名
        if (categorySelect) {
          categorySelect.value = "";
          categorySelect.disabled = true;
        }
        if (newCategoryInput) {
          newCategoryInput.disabled = true;
          newCategoryInput.style.display = "none";
        }
      });

      // Delete button
      const deleteBtn = document.createElement("button");
      deleteBtn.type = "button";
      deleteBtn.className = "icon-button delete-btn";
      const deleteImg = document.createElement("img");
      deleteImg.src = "{{ url_for('static', filename='delete.png') }}";
      deleteImg.alt = "Delete";
      deleteBtn.appendChild(deleteImg);

      deleteBtn.addEventListener("click", function () {
        categories.splice(index, 1);
        if (editingIndex === index) {
          editingIndex = null;
          if (categoryAmountInput) categoryAmountInput.value = "";
        }
        if (categorySelect) categorySelect.disabled = false;
        if (newCategoryInput) newCategoryInput.disabled = false;

        totalEditedManually = false;
        renderCategoryTable();
        updateTotalIfNotEdited();
      });

      tdActions.appendChild(editBtn);
      tdActions.appendChild(deleteBtn);
      tr.appendChild(tdActions);
      {% endif %}

      categoryTableBody.appendChild(tr);
    });
  }

  function getCategoriesSum() {
    return categories.reduce((sum, c) => sum + (c.amount || 0), 0);
  }

  function updateTotalIfNotEdited() {
    if (!totalEditedManually && totalBudgetInput) {
      const sum = getCategoriesSum();
      if (sum > 0) {
        totalBudgetInput.value = sum.toFixed(2);
      }
    }
  }

  if (totalBudgetInput) {
    totalBudgetInput.addEventListener("focus", function () {
      totalEditedManually = true;
    });

    totalBudgetInput.addEventListener("blur", function () {
      const manualTotal = parseFloat(totalBudgetInput.value);
      const sum = getCategoriesSum();

      if (!isNaN(manualTotal) && manualTotal > sum) {
        const extraAmount = manualTotal - sum;
        const existingExtra = categories.find(c => c.category === "extra");
        if (existingExtra) {
          existingExtra.amount += extraAmount;
        } else {
          categories.push({ category: "extra", amount: extraAmount });
        }
        renderCategoryTable();
      }
    });
  }

  if (budgetForm) {
    budgetForm.addEventListener("submit", function () {
      if (categoriesJsonInput) {
        categoriesJsonInput.value = JSON.stringify(categories);
      }
    });
  }

  // 页面一加载就把已有预算渲染出来
  renderCategoryTable();
  updateTotalIfNotEdited();

  // Initialize charts after Chart.js loads - wait longer to ensure it's ready
  function waitForChartJS(callback, maxAttempts = 20) {
    if (typeof Chart !== 'undefined') {
      callback();
    } else if (maxAttempts > 0) {
      setTimeout(() => waitForChartJS(callback, maxAttempts - 1), 100);
    } else {
      console.error('Chart.js failed to load after 2 seconds');
    }
  }
  waitForChartJS(initializeCharts);
});

// Chart initialization function
function initializeCharts() {
  // Check if Chart.js is loaded
  if (typeof Chart === 'undefined') {
    console.error('Chart.js library not loaded!');
    return;
  }

  // Get data from Flask - tojson filter produces valid JavaScript directly (no JSON.parse needed!)
  // This follows W3Schools Chart.js best practice
  {% if plan and plan.category_budgets %}
  const plannedData = {{ plan.category_budgets | tojson }};
  {% else %}
  const plannedData = {{ planned_category_budgets | default({}) | tojson }};
  {% endif %}
  const actualData = {{ actual_category_totals | default({}) | tojson }};
  const expenseData = {{ category_totals | default({}) | tojson }};

  console.log('=== Chart Data Loaded ===');
  console.log('Planned:', plannedData);
  console.log('Actual:', actualData);
  console.log('Expenses:', expenseData);

  // ============================================
  // BAR CHART: Planned vs Actual by Category
  // ============================================
  const barCanvas = document.getElementById('plannedActualChart');
  const barEmpty = document.getElementById('bar-chart-empty');

  console.log('Bar canvas element:', barCanvas);
  console.log('Bar empty element:', barEmpty);

  if (!barCanvas) {
    console.error('Bar chart canvas not found!');
    return;
  }

  const categories = Object.keys(plannedData || {});
  console.log('Categories for bar chart:', categories);
  
  if (categories.length > 0) {
    console.log('Creating bar chart with', categories.length, 'categories');
    // Hide empty state, show chart
    if (barEmpty) barEmpty.style.display = 'none';
    barCanvas.style.display = 'block';

      const plannedValues = categories.map(cat => Number(plannedData[cat] || 0));
      const actualValues = categories.map(cat => Number(actualData[cat] || 0));

      try {
        const ctx = barCanvas.getContext('2d');
        new Chart(ctx, {
          type: 'bar',
          data: {
            labels: categories,
            datasets: [{
              label: 'Planned',
              data: plannedValues,
              backgroundColor: 'rgba(54, 162, 235, 0.6)',
              borderColor: 'rgba(54, 162, 235, 1)',
              borderWidth: 1
            }, {
              label: 'Actual',
              data: actualValues,
              backgroundColor: 'rgba(255, 99, 132, 0.6)',
              borderColor: 'rgba(255, 99, 132, 1)',
              borderWidth: 1
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              y: {
                beginAtZero: true,
                ticks: {
                  callback: function(value) {
                    return '$' + value;
                  }
                }
              }
            },
            plugins: {
              legend: {
                position: 'top'
              },
              tooltip: {
                callbacks: {
                  label: function(context) {
                    return context.dataset.label + ': $' + context.parsed.y.toFixed(2);
                  }
                }
              }
            }
          }
        });
        console.log('✅ Bar chart rendered successfully!');
      } catch (error) {
        console.error('❌ Error creating bar chart:', error);
        console.error('Error details:', error.message, error.stack);
        if (barEmpty) barEmpty.style.display = 'block';
        barCanvas.style.display = 'none';
      }
    } else {
      console.log('No categories found, showing empty state');
      // Show empty state
      if (barEmpty) barEmpty.style.display = 'block';
      barCanvas.style.display = 'none';
    }
  } else {
    console.error('Bar canvas element not found in DOM!');
  }

  // ============================================
  // PIE CHART: Spending by Category
  // ============================================
  const pieCanvas = document.getElementById('expensePieChart');
  const pieEmpty = document.getElementById('pie-chart-empty');

  console.log('Pie canvas element:', pieCanvas);
  console.log('Pie empty element:', pieEmpty);

  if (!pieCanvas) {
    console.error('Pie chart canvas not found!');
    return;
  }

  const expenseLabels = Object.keys(expenseData || {});
  const expenseValues = Object.values(expenseData || {});
  const hasData = expenseValues.some(v => v > 0);

  console.log('Expense labels:', expenseLabels);
  console.log('Expense values:', expenseValues);
  console.log('Has expense data:', hasData);

  if (hasData) {
    console.log('Creating pie chart with', expenseLabels.length, 'categories');
    // Hide empty state, show chart
    if (pieEmpty) pieEmpty.style.display = 'none';
    pieCanvas.style.display = 'block';

      try {
        const ctx = pieCanvas.getContext('2d');
        new Chart(ctx, {
          type: 'pie',
          data: {
            labels: expenseLabels,
            datasets: [{
              data: expenseValues,
              backgroundColor: [
                '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0',
                '#9966FF', '#FF9F40', '#FF6384', '#C9CBCF'
              ],
              borderWidth: 2,
              borderColor: '#fff'
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                position: 'bottom'
              },
              tooltip: {
                callbacks: {
                  label: function(context) {
                    const label = context.label || '';
                    const value = context.parsed || 0;
                    const total = expenseValues.reduce((a, b) => a + b, 0);
                    const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                    return label + ': $' + value.toFixed(2) + ' (' + percentage + '%)';
                  }
                }
              }
            }
          }
        });
        console.log('✅ Pie chart rendered successfully!');
      } catch (error) {
        console.error('❌ Error creating pie chart:', error);
        console.error('Error details:', error.message, error.stack);
        if (pieEmpty) pieEmpty.style.display = 'block';
        pieCanvas.style.display = 'none';
      }
    } else {
      console.log('No expense data, showing empty state');
      // Show empty state
      if (pieEmpty) pieEmpty.style.display = 'block';
      pieCanvas.style.display = 'none';
    }
  } else {
    console.error('Pie canvas element not found in DOM!');
  }
  
  console.log('=== Chart initialization complete ===');
}
</script>

<script src="{{ url_for('static', filename='js/main.js') }}"></script>
{% endblock %}
