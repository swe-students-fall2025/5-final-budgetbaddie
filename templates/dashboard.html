{% extends "base.html" %}
{% block content %}

<div class="top-bar">
  <h2 class="greeting">Hello, {{ user.email }}</h2>

  <div class="top-icons">
    <button id="open-budget-modal" class="icon-button">
      <img src="{{ url_for('static', filename='budget.png') }}" alt="Budget" class="budget-icon">
    </button>

    <a href="{{ url_for('logout') }}" class="logout-button">
      <img src="{{ url_for('static', filename='logout.png') }}" alt="Logout">
    </a>
  </div>
</div>

<!-- Budget modal -->
<div id="budget-modal" class="modal {% if need_budget_popup %}show{% endif %}">
  <div class="modal-content">
    <h3>
      Budget for {{ current_month }}/{{ current_year }}
      {% if plan and plan.is_locked %}(Locked){% endif %}
    </h3>

    <form id="budget-form" method="POST" action="{{ url_for('save_budget_plan') }}">
      <input type="hidden" name="year" value="{{ current_year }}">
      <input type="hidden" name="month" value="{{ current_month }}">

      <!-- JSON for category budgets -->
      <input type="hidden" name="categories_json" id="categories-json">

      <!-- Category dropdown + New category input -->
      <div class="field-row">
        <label>Category</label>
        <select id="category-select" {% if not can_edit_budget %}disabled{% endif %}>
          <option value="" disabled selected>Choose existing category</option>
          <option value="Rent">Rent</option>
          <option value="Groceries">Groceries</option>
          <option value="Transport">Transport</option>
          <option value="Entertainment">Entertainment</option>
          <option value="New">+ New category...</option>
        </select>

        <input
          type="text"
          id="new-category-input"
          placeholder="New category name"
          style="display:none;"
          {% if not can_edit_budget %}disabled{% endif %}
        >
      </div>

      <!-- Amount input -->
      <div class="field-row">
        <label>Amount for this category</label>
        <input
          type="number"
          step="0.01"
          id="category-amount-input"
          {% if not can_edit_budget %}disabled{% endif %}
        >
        <button
          type="button"
          id="add-category-btn"
          {% if not can_edit_budget %}disabled{% endif %}
        >
          Add to plan
        </button>
      </div>

      <!-- Category table -->
      <div class="field-row">
        <h4>Current category budgets</h4>
        <table id="category-table">
          <thead>
            <tr>
              <th>Category</th>
              <th>Amount</th>
              {% if can_edit_budget %}
              <th>Actions</th>
              {% endif %}
            </tr>
          </thead>
          <tbody>
            <!-- Filled by JS -->
          </tbody>
        </table>
      </div>

      <!-- Total budget (auto sum, but editable) -->
      <div class="field-row">
        <label>Total monthly budget</label>
        <input
          type="number"
          step="0.01"
          name="total_budget"
          id="total-budget-input"
          placeholder="Auto sum of categories..."
          value="{{ plan.total_budget if plan else '' }}"
          {% if not can_edit_budget %}disabled{% endif %}
        >
      </div>

      {% if can_edit_budget %}
      <div class="field-row">
        <label class="lock-wrapper">
          <input type="checkbox" name="lock_budget" id="lock-budget-checkbox">
          <img
            src="{{ url_for('static', filename='lock.png') }}"
            alt="Lock"
            class="lock-icon"
            title="Click to lock the budget amount, you won't be able to make changes until next month!"
          >
          <span>Lock this month's budget</span>
        </label>
      </div>

      <button type="submit">Save</button>
      {% else %}
      <p>This month's budget is locked. You can only view it.</p>
      {% endif %}
    </form>

    <button type="button" id="close-budget-modal" class="close-btn">Close</button>
  </div>
</div>

<!-- 简单预算总览（非弹窗） -->
{% if not need_budget_popup %}
<section class="budget-diagram">
  <h3>This Month's Budget</h3>
  <div id="budget-chart">
    <p>Total budget: {{ '%.2f'|format(plan.total_budget) if plan else 'N/A' }}</p>
  </div>
</section>
{% endif %}

<!-- Expense 部分保留 -->
{% if not need_budget_popup %}
<section class="add-expense">
  <h3>Add Expense</h3>
  <form method="POST" action="{{ url_for('add_expense') }}">
    <label>Date</label>
    <input type="date" name="date" required>

    <label>Category</label>
    <input type="text" name="category" required>

    <label>Amount</label>
    <input type="number" step="0.01" name="amount" required>

    <label>
      <input type="checkbox" name="is_recurring">
      Recurring
    </label>

    <button type="submit">Add</button>
  </form>
</section>

<section class="expense-list">
  <h3>This Month's Expenses</h3>
  <table>
    <thead>
      <tr>
        <th>Date</th>
        <th>Category</th>
        <th>Amount</th>
        <th>Recurring</th>
      </tr>
    </thead>
    <tbody>
      {% for e in expenses %}
      <tr>
        <td>{{ e.date.strftime('%Y-%m-%d') if e.date else '' }}</td>
        <td>{{ e.category }}</td>
        <td>{{ '%.2f'|format(e.amount) }}</td>
        <td>{{ 'Yes' if e.is_recurring else 'No' }}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</section>
{% endif %}

<!-- 所有 JS 合并到一个 DOMContentLoaded 里 -->
<script>
document.addEventListener("DOMContentLoaded", function () {
  // ====== Modal open / close ======
  const modal = document.getElementById("budget-modal");
  const openBtn = document.getElementById("open-budget-modal");
  const closeBtn = document.getElementById("close-budget-modal");

  function openModal() {
    if (modal) modal.classList.add("show");
  }
  function closeModal() {
    if (modal) modal.classList.remove("show");
  }

  if (openBtn) {
    openBtn.addEventListener("click", openModal);
  }
  if (closeBtn) {
    closeBtn.addEventListener("click", closeModal);
  }
  if (modal) {
    modal.addEventListener("click", function (event) {
      if (event.target === modal) {
        closeModal();
      }
    });
  }

  // ====== Budget categories logic ======
  const categorySelect      = document.getElementById("category-select");
  const newCategoryInput    = document.getElementById("new-category-input");
  const categoryAmountInput = document.getElementById("category-amount-input");
  const addCategoryBtn      = document.getElementById("add-category-btn");
  const categoryTableBody   = document.querySelector("#category-table tbody");
  const totalBudgetInput    = document.getElementById("total-budget-input");
  const categoriesJsonInput = document.getElementById("categories-json");
  const budgetForm          = document.getElementById("budget-form");

  let categories = [];
  let totalEditedManually = false;
  let editingIndex = null;

  // 从后端加载已有的 category_budgets
  const initialCategoryBudgets = {{ plan.category_budgets | default({}) | tojson }};

  for (const [name, amount] of Object.entries(initialCategoryBudgets)) {
    categories.push({
      category: name,
      amount: Number(amount) || 0
    });
  }

  // 下拉选择“New” → 显示输入框
  if (categorySelect) {
    categorySelect.addEventListener("change", function () {
      if (this.value === "New") {
        newCategoryInput.style.display = "inline-block";
        newCategoryInput.focus();
      } else {
        newCategoryInput.style.display = "none";
      }
    });
  }

  // 添加 / 更新 category
    if (addCategoryBtn) {
    addCategoryBtn.addEventListener("click", function () {
      const amountValue = parseFloat(categoryAmountInput.value);

      if (isNaN(amountValue) || amountValue <= 0) {
        alert("Please enter a valid positive amount.");
        return;
      }

      let categoryName;

      if (editingIndex !== null) {
        // ✏️ 编辑状态：只改金额，不改类别
        categoryName = categories[editingIndex].category;
        categories[editingIndex].amount = amountValue;

        // 结束编辑，恢复输入控件
        editingIndex = null;
        if (categorySelect) {
          categorySelect.disabled = false;
          categorySelect.value = "";
        }
        if (newCategoryInput) {
          newCategoryInput.disabled = false;
          newCategoryInput.value = "";
          newCategoryInput.style.display = "none";
        }
      } else {
        // ➕ 新增状态：需要一个类别
        if (categorySelect.value === "New") {
          categoryName = newCategoryInput.value.trim();
        } else {
          categoryName = categorySelect.value;
        }

        if (!categoryName) {
          alert("Please choose or enter a category name.");
          return;
        }

        const existing = categories.find(c => c.category === categoryName);
        if (existing) {
          existing.amount = amountValue;
        } else {
          categories.push({ category: categoryName, amount: amountValue });
        }

        // 清理类别输入
        if (categorySelect) categorySelect.value = "";
        if (newCategoryInput) {
          newCategoryInput.value = "";
          newCategoryInput.style.display = "none";
        }
      }

      // 清理金额输入
      categoryAmountInput.value = "";

      renderCategoryTable();
      updateTotalIfNotEdited();
    });
  }


  function renderCategoryTable() {
    if (!categoryTableBody) return;
    categoryTableBody.innerHTML = "";

    categories.forEach((item, index) => {
      const tr = document.createElement("tr");

      const tdName = document.createElement("td");
      tdName.textContent = item.category;

      const tdAmount = document.createElement("td");
      tdAmount.textContent = item.amount.toFixed(2);

      tr.appendChild(tdName);
      tr.appendChild(tdAmount);

      {% if can_edit_budget %}
      // Actions: Edit / Delete
      const tdActions = document.createElement("td");

      // Edit button
      const editBtn = document.createElement("button");
      editBtn.type = "button";
      editBtn.className = "icon-button edit-btn";
      const editImg = document.createElement("img");
      editImg.src = "{{ url_for('static', filename='edit.png') }}";
      editImg.alt = "Edit";
      editBtn.appendChild(editImg);

      editBtn.addEventListener("click", function () {
        editingIndex = index;
        if (categoryAmountInput) {
          categoryAmountInput.value = item.amount.toFixed(2);
        }
        // 不允许在编辑中改 category 名
        if (categorySelect) {
          categorySelect.value = "";
          categorySelect.disabled = true;
        }
        if (newCategoryInput) {
          newCategoryInput.disabled = true;
          newCategoryInput.style.display = "none";
        }
      });

      // Delete button
      const deleteBtn = document.createElement("button");
      deleteBtn.type = "button";
      deleteBtn.className = "icon-button delete-btn";
      const deleteImg = document.createElement("img");
      deleteImg.src = "{{ url_for('static', filename='delete.png') }}";
      deleteImg.alt = "Delete";
      deleteBtn.appendChild(deleteImg);

      deleteBtn.addEventListener("click", function () {
        categories.splice(index, 1);
        if (editingIndex === index) {
          editingIndex = null;
          if (categoryAmountInput) categoryAmountInput.value = "";
        }
        if (categorySelect) categorySelect.disabled = false;
        if (newCategoryInput) newCategoryInput.disabled = false;

        totalEditedManually = false;
        renderCategoryTable();
        updateTotalIfNotEdited();
      });

      tdActions.appendChild(editBtn);
      tdActions.appendChild(deleteBtn);
      tr.appendChild(tdActions);
      {% endif %}

      categoryTableBody.appendChild(tr);
    });
  }

  function getCategoriesSum() {
    return categories.reduce((sum, c) => sum + (c.amount || 0), 0);
  }

  function updateTotalIfNotEdited() {
    if (!totalEditedManually && totalBudgetInput) {
      const sum = getCategoriesSum();
      if (sum > 0) {
        totalBudgetInput.value = sum.toFixed(2);
      }
    }
  }

  if (totalBudgetInput) {
    totalBudgetInput.addEventListener("focus", function () {
      totalEditedManually = true;
    });

    totalBudgetInput.addEventListener("blur", function () {
      const manualTotal = parseFloat(totalBudgetInput.value);
      const sum = getCategoriesSum();

      if (!isNaN(manualTotal) && manualTotal > sum) {
        const extraAmount = manualTotal - sum;
        const existingExtra = categories.find(c => c.category === "extra");
        if (existingExtra) {
          existingExtra.amount += extraAmount;
        } else {
          categories.push({ category: "extra", amount: extraAmount });
        }
        renderCategoryTable();
      }
    });
  }

  if (budgetForm) {
    budgetForm.addEventListener("submit", function () {
      if (categoriesJsonInput) {
        categoriesJsonInput.value = JSON.stringify(categories);
      }
    });
  }

  // 页面一加载就把已有预算渲染出来
  renderCategoryTable();
  updateTotalIfNotEdited();
});
</script>

{% endblock %}
