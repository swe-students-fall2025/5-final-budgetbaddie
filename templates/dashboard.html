{% extends "base.html" %}
{% block content %}

<div class="top-bar">
  <h2 class="greeting">Hello, {{ user.email }}</h2>

  <div class="top-icons">
    <!-- Savings button -->
    <button id="open-savings-modal" class="icon-button">
      <img src="{{ url_for('static', filename='savings.png') }}" alt="Savings" class="budget-icon">
      <span class="tooltip">View Savings</span>
    </button>

    <button id="open-budget-modal" class="icon-button">
      <img src="{{ url_for('static', filename='budget.png') }}" alt="Budget" class="budget-icon">
      <span class="tooltip">Set Budget</span>
    </button>

    <button id="open-income-modal" class="icon-button">
      <img src="{{ url_for('static', filename='income.png') }}" alt="Add Income" class="budget-icon">
      <span class="tooltip">Add Income</span>
    </button>

    <button id="open-expense-modal" class="icon-button">
      <img src="{{ url_for('static', filename='add_expense.png') }}" alt="Add Expense" class="budget-icon">
      <span class="tooltip">Add Expense</span>
    </button>

    <button id="open-ai-modal" class="icon-button">
      <span class="ai-emoji">ğŸ¤–</span>
      <span class="tooltip">Ask AI Budget Advisor</span>
    </button>

    <a href="{{ url_for('logout') }}" class="logout-button">
      <img src="{{ url_for('static', filename='logout.png') }}" alt="Logout">
      <span class="tooltip">Logout</span>
    </a>
  </div>
</div>


<!-- savings modal -->
<div id="savings-modal" class="modal">
  <div class="modal-content savings-modal-content">
    <h3>Your Savings</h3>

    {% if monthly_savings and monthly_savings|length > 0 %}
      <ul class="savings-list">
        {% for row in monthly_savings %}
        <li class="savings-row">
          <span class="savings-month">
            {{ row.month_name }} {{ row.year }}
          </span>
          <span class="savings-amount">
            $ {{ "%.2f"|format(row.savings) }}
          </span>
        </li>
        {% endfor %}
      </ul>

      <hr class="savings-divider">

      <p class="savings-total-line">
        <span>Total Savings:</span>
        <span class="savings-amount">
          $ {{ "%.2f"|format(total_savings) }}
        </span>
      </p>
    {% else %}
      <p>You don't have positive savings yet. Start tracking your income &amp; expenses!</p>
    {% endif %}

    <button type="button" id="close-savings-modal" class="close-btn">Close</button>
  </div>
</div>



<!-- Budget modal -->
<div id="budget-modal" class="modal {% if need_budget_popup %}show{% endif %}">
  <div class="modal-content">
    <h3>
      Budget for {{ current_month }}/{{ current_year }}
      {% if plan and plan.is_locked %}(Locked){% endif %}
    </h3>

    <form id="budget-form" method="POST" action="{{ url_for('save_budget_plan') }}">
      <input type="hidden" name="year" value="{{ current_year }}">
      <input type="hidden" name="month" value="{{ current_month }}">

      <!-- JSON for category budgets -->
      <input type="hidden" name="categories_json" id="categories-json">

      <!-- Category dropdown + New category input -->
      <div class="field-row">
        <label>Category</label>
        <select id="category-select" {% if not can_edit_budget %}disabled{% endif %}>
          <option value="" disabled selected>Choose existing category</option>
          <option value="Rent">Rent</option>
          <option value="Groceries">Groceries</option>
          <option value="Transport">Transport</option>
          <option value="Entertainment">Entertainment</option>
          <option value="New">+ New category...</option>
        </select>

        <input
          type="text"
          id="new-category-input"
          placeholder="New category name"
          style="display:none;"
          {% if not can_edit_budget %}disabled{% endif %}
        >
      </div>

      <!-- Amount input -->
      <div class="field-row">
        <label>Amount for this category</label>
        <input
          type="number"
          step="0.01"
          id="category-amount-input"
          {% if not can_edit_budget %}disabled{% endif %}
        >
        <button
          type="button"
          id="add-category-btn"
          {% if not can_edit_budget %}disabled{% endif %}
        >
          Add to plan
        </button>
      </div>

      <!-- Category table -->
      <div class="field-row">
        <h4>Current budgets</h4>
        <table id="category-table">
          <thead>
            <tr>
              <th>Category</th>
              <th>Amount</th>
              {% if can_edit_budget %}
              <th>Actions</th>
              {% endif %}
            </tr>
          </thead>
          <tbody>
            <!-- Filled by JS -->
          </tbody>
        </table>
      </div>

      <!-- Total budget (auto sum, but editable) -->
      <div class="field-row">
        <label>Total monthly budget</label>
        <input
          type="number"
          step="0.01"
          name="total_budget"
          id="total-budget-input"
          placeholder="Auto sum of categories..."
          value="{{ plan.total_budget if plan else '' }}"
          {% if not can_edit_budget %}disabled{% endif %}
        >
      </div>

      {% if can_edit_budget %}
      <div class="field-row">
        <label class="lock-wrapper">
          <input type="checkbox" name="lock_budget" id="lock-budget-checkbox">
          <img
            src="{{ url_for('static', filename='lock.png') }}"
            alt="Lock"
            class="lock-icon"
            title="Click to lock the budget amount, you won't be able to make changes until next month!"
          >
          <span>Lock this month's budget</span>
        </label>
      </div>

      <button type="submit">Save</button>
      {% else %}
      <p>This month's budget is locked. You can only view it.</p>
      {% endif %}
    </form>

    <button type="button" id="close-budget-modal" class="close-btn">Close</button>
  </div>
</div>

<!-- budget vs expenses overview -->
{% if not need_budget_popup %}
<section class="budget-expenses-overview">
  <h2>Budget vs Expenses for {{ current_month }}/{{ current_year }}</h2>
  
  <div class="overview-grid">
    <!-- budget categories -->
    <div class="budget-section">
      <h3>Budget Plan</h3>
      <div class="budget-total-box">
        Total Budget: ${{ '%.2f'|format(plan.total_budget) if plan else '0.00' }}
      </div>
      
      {% if plan and plan.category_budgets %}
      <div class="category-list">
        {% for category, amount in plan.category_budgets.items() %}
        <div class="category-item budget-item">
          <span class="category-name">{{ category }}</span>
          <span class="category-amount">${{ '%.2f'|format(amount) }}</span>
        </div>
        {% endfor %}
      </div>
      {% else %}
      <p class="no-data">No budget categories set</p>
      {% endif %}
    </div>
    
    <!-- actual expenses -->
    <div class="expenses-section">
      <h3>Actual Expenses</h3>
      
      {% set expense_by_category = {} %}
      {% for e in expenses %}
        {% if e.category in expense_by_category %}
          {% set _ = expense_by_category.update({e.category: expense_by_category[e.category] + e.amount}) %}
        {% else %}
          {% set _ = expense_by_category.update({e.category: e.amount}) %}
        {% endif %}
      {% endfor %}
      
      {% set total_expenses = expense_by_category.values()|sum %}
      <div class="expenses-total-box">
        Total Spent: ${{ '%.2f'|format(total_expenses) }}
      </div>
      
      {% if expense_by_category %}
      <div class="category-list">
        {% for category, amount in expense_by_category.items() %}
        <div class="category-item expense-item">
          <span class="category-name">{{ category }}</span>
          <span class="category-amount">${{ '%.2f'|format(amount) }}</span>
        </div>
        {% endfor %}
      </div>
      {% else %}
      <p class="no-data">No expenses yet</p>
      {% endif %}
    </div>
    
    <!-- expense breakdown chart -->
    <div class="chart-section">
      <h3>Expense Breakdown</h3>
      {% if expense_by_category %}
      <div class="chart-container">
        <canvas id="expense-pie-chart"></canvas>
      </div>
      {% else %}
      <p class="no-data">Add expenses to see the chart</p>
      {% endif %}
    </div>
  </div>
</section>
{% endif %}

<!-- category budget analysis -->
{% if not need_budget_popup and plan and plan.category_budgets %}
<section class="category-analysis">
  <h2>Budget vs Spending by Category</h2>
  
  <div class="category-grid">
    {% for category, budget_amount in plan.category_budgets.items() %}
    {% set spent_amount = expense_by_category.get(category, 0) %}
    {% set percentage = (spent_amount / budget_amount * 100) if budget_amount > 0 else 0 %}
    {% if percentage <= 90 %}
      {% set status_class = "status-under" %}
      {% set status_text = "Under Budget" %}
    {% elif percentage <= 100 %}
      {% set status_class = "status-close" %}
      {% set status_text = "Close to Budget" %}
    {% else %}
      {% set status_class = "status-over" %}
      {% set status_text = "Over Budget!" %}
    {% endif %}
    
    <div class="category-card {{ status_class }}">
      <h3 class="category-title">{{ category }}</h3>
      <div class="category-amounts">
        <div class="amount-row">
          <span class="amount-label">Budget:</span>
          <span class="amount-value">${{ '%.2f'|format(budget_amount) }}</span>
        </div>
        <div class="amount-row">
          <span class="amount-label">Spent:</span>
          <span class="amount-value">${{ '%.2f'|format(spent_amount) }}</span>
        </div>
      </div>
      
      <div class="progress-bar-container">
        <div class="progress-bar {{ status_class }}" style="width: {{ [percentage, 100]|min }}%"></div>
      </div>
      
      <div class="category-status">
        <span class="status-percentage">{{ '%.1f'|format(percentage) }}%</span>
        <span class="status-label">{{ status_text }}</span>
      </div>
    </div>
    {% endfor %}
  </div>
</section>
{% endif %}

<!-- income capacity tracker -->
{% if not need_budget_popup %}
<section class="income-tracker">
  <h2>Income Capacity Tracker</h2>
  
  {% set total_budget = plan.total_budget if plan else 0 %}
  {% set total_spent = expense_by_category.values()|sum %}
  {% set remaining_budget = total_budget - total_spent %}
  {% set planned_savings = total_income - total_budget %}
  {% set actual_savings = total_income - total_spent %}
  
  <div class="tracker-container">
    <canvas id="income-capacity-chart"></canvas>
  </div>
  
  <div class="tracker-summary">
    <div class="summary-card">
      <div class="summary-label">Total Income</div>
      <div class="summary-amount income-amount">${{ '%.2f'|format(total_income) }}</div>
      <div class="summary-subtitle">What you earned</div>
    </div>
    
    <div class="summary-card">
      <div class="summary-label">Total Budgeted</div>
      <div class="summary-amount budget-amount">${{ '%.2f'|format(total_budget) }}</div>
      <div class="summary-subtitle">What you planned</div>
    </div>
    
    <div class="summary-card">
      <div class="summary-label">Total Spent</div>
      <div class="summary-amount spent-amount">${{ '%.2f'|format(total_spent) }}</div>
      <div class="summary-subtitle">What you actually spent</div>
    </div>
    
    <div class="summary-card">
      <div class="summary-label">Remaining Budget</div>
      <div class="summary-amount {% if remaining_budget < 0 %}danger-amount{% else %}remaining-amount{% endif %}">${{ '%.2f'|format(remaining_budget) }}</div>
      <div class="summary-subtitle">Budget - Spent</div>
    </div>
    
    <div class="summary-card">
      <div class="summary-label">Planned Savings</div>
      <div class="summary-amount {% if planned_savings < 0 %}danger-amount{% else %}savings-amount{% endif %}">${{ '%.2f'|format(planned_savings) }}</div>
      <div class="summary-subtitle">Income - Budget</div>
    </div>
    
    <div class="summary-card">
      <div class="summary-label">Actual Savings</div>
      <div class="summary-amount {% if actual_savings < 0 %}danger-amount{% else %}success-amount{% endif %}">${{ '%.2f'|format(actual_savings) }}</div>
      <div class="summary-subtitle">Income - Spent</div>
    </div>
    
    <div class="summary-card status-card">
      <div class="summary-label">Status</div>
      <div class="summary-status">
        {% if total_spent > total_income %}
          <span class="status-warning">âš ï¸ Overspending!</span>
        {% elif total_spent > total_budget %}
          <span class="status-warning">âš ï¸ Over Budget!</span>
        {% elif remaining_budget < total_budget * 0.1 and remaining_budget >= 0 %}
          <span class="status-close">âš¡ Tight Budget</span>
        {% elif planned_savings < 0 %}
          <span class="status-warning">âš ï¸ Budget Exceeds Income!</span>
        {% else %}
          <span class="status-good">âœ“ Healthy</span>
        {% endif %}
      </div>
    </div>
  </div>
</section>
{% endif %}

<!-- AI Advice Modal -->
<div id="ai-modal" class="modal">
  <div class="modal-content ai-modal-content">
    <h3>ğŸ’¡ AI Budget Advisor</h3>
    
    <div id="ai-conversation" class="ai-conversation">
      <p class="ai-welcome">Ask me anything about your budget! For example:</p>
      <ul class="ai-examples">
        <li>"Can I afford a $50 dinner?"</li>
        <li>"Should I buy a $200 jacket?"</li>
        <li>"Do I have room in my budget for a $30 subscription?"</li>
      </ul>
    </div>
    
    <form id="ai-form">
      <div class="field-row">
        <textarea
          id="ai-question"
          name="question"
          rows="3"
          placeholder="Ask your budget question..."
          required
        ></textarea>
      </div>
      
      <div class="ai-buttons">
        <button type="submit" id="ai-submit-btn">
          <span class="btn-text">Get Advice</span>
          <span class="btn-loading" style="display: none;">Thinking...</span>
        </button>
        <button type="button" id="close-ai-modal" class="close-btn">Close</button>
      </div>
    </form>
  </div>
</div>

<!-- ========= Add Expense modal ========= -->
<div id="expense-modal" class="modal">
  <div class="modal-content">
    <h3>Add Expense</h3>

    <form id="expense-form" method="POST" action="{{ url_for('add_expense') }}">
      <div class="field-row">
        <label>Date</label>
        <input type="date" name="date" required>
      </div>

      <div class="field-row">
        <label>Category</label>

        <!-- ä¸‹æ‹‰é€‰å·²æœ‰é¢„ç®—é‡Œçš„åˆ†ç±» -->
        <select id="expense-category-select">
          <option value="" disabled selected>Choose category</option>
          {% if plan and plan.category_budgets %}
            {% for cat in plan.category_budgets.keys() %}
              <option value="{{ cat }}">{{ cat }}</option>
            {% endfor %}
          {% endif %}
          <option value="__new__">+ New category...</option>
        </select>

        <!-- æ–°åˆ†ç±»è¾“å…¥æ¡† -->
        <input
          type="text"
          id="expense-new-category-input"
          placeholder="New category name"
          style="display:none;"
        >

        <!-- çœŸæ­£æäº¤ç»™åç«¯çš„å­—æ®µ -->
        <input type="hidden" name="category" id="expense-category-final">
      </div>

      <div class="field-row">
        <label>Amount</label>
        <input type="number" step="0.01" name="amount" required>
      </div>

      <div class="field-row">
        <label>Note</label>
        <textarea
          name="note"
          id="expense-note"
          rows="3"
          placeholder="Optional note for this expense"
        ></textarea>
      </div>

      <button type="submit">Add</button>
      <button type="button" id="close-expense-modal" class="close-btn">Close</button>
    </form>
  </div>
</div>

<section class="expense-list">
  <div class="section-header">
    <h3>Your this month's expenses</h3>
    <button id="open-search-modal" class="btn-primary">
      <img src="{{ url_for('static', filename='search.png') }}" alt="Search" style="width: 18px; height: 18px; vertical-align: middle; margin-right: 8px;">
      Search Entries
    </button>
  </div>
  
  <table>
    <thead>
      <tr>
        <th>Date</th>
        <th>Category</th>
        <th>Amount</th>
        <th>Note</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="expenses-table-body">
      {% for e in expenses %}
      <tr>
        <td>{{ e.date.strftime('%Y-%m-%d') if e.date else '' }}</td>
        <td>{{ e.category }}</td>
        <td>${{ '%.2f'|format(e.amount) }}</td>
        <td class="note-cell">{{ e.note if e.note else '-' }}</td>
        <td>
          <form method="POST" action="{{ url_for('delete_expense', expense_id=e._id) }}" style="display: inline;" onsubmit="return confirm('Delete this expense?');">
            <button type="submit" class="icon-button delete-btn">
              <img src="{{ url_for('static', filename='delete.png') }}" alt="Delete">
            </button>
          </form>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</section>

<!-- Search Modal -->
<div id="search-modal" class="modal">
  <div class="modal-content">
    <h3>Search Expenses</h3>
    
    <div class="field-row">
      <label>Search by Category, Amount, or Note</label>
      <input type="text" id="search-input" placeholder="Type to search...">
    </div>
    
    <div class="field-row">
      <label>Date Range</label>
      <div style="display: flex; gap: 1rem;">
        <input type="date" id="search-date-from" placeholder="From">
        <input type="date" id="search-date-to" placeholder="To">
      </div>
    </div>
    
    <div class="field-row">
      <label>Filter by Category</label>
      <select id="search-category">
        <option value="">All Categories</option>
        {% if plan and plan.category_budgets %}
          {% for cat in plan.category_budgets.keys() %}
            <option value="{{ cat }}">{{ cat }}</option>
          {% endfor %}
        {% endif %}
      </select>
    </div>
    
    <button type="button" id="search-btn" class="btn-primary">Search</button>
    <button type="button" id="clear-search-btn">Clear Filters</button>
    <button type="button" id="close-search-modal" class="close-btn">Close</button>
    
    <div id="search-results" style="margin-top: 1.5rem;">
      <!-- Results will appear here -->
    </div>
  </div>
</section>



<!-- ========= Add Income modal ========= -->
<!-- ========= Add Income modal ========= -->
<div id="income-modal" class="modal">
  <div class="modal-content">
    <h3>Add Income</h3>

    <form id="income-form" method="POST" action="{{ url_for('add_income') }}">
      <!-- æ—¥æœŸ -->
      <div class="field-row">
        <label>Date</label>
        <input type="date" name="date" required>
      </div>

      <!-- æ”¶å…¥æ¥æº -->
      <div class="field-row">
        <label>Source</label>
        <input
          type="text"
          name="source"
          placeholder="Salary, refund, bonus..."
          required
        >
      </div>

      <!-- é‡‘é¢ -->
      <div class="field-row">
        <label>Amount</label>
        <input type="number" step="0.01" name="amount" required>
      </div>

      <!-- å¤‡æ³¨ -->
      <div class="field-row">
        <label>Note</label>
        <textarea
          name="note"
          rows="2"
          placeholder="Optional note for this income"
        ></textarea>
      </div>

      <button type="submit">Add</button>
      <button type="button" id="close-income-modal" class="close-btn">Close</button>
    </form>
  </div>
</div>



<!-- æ‰€æœ‰ JS åˆå¹¶åˆ°ä¸€ä¸ª DOMContentLoaded é‡Œ -->
<script>
document.addEventListener("DOMContentLoaded", function () {

  // ======================================================
  // 1. ç»Ÿä¸€è·å–æ‰€æœ‰å’Œå¼¹çª— / æŒ‰é’®ç›¸å…³çš„ DOM å…ƒç´ 
  // ======================================================
  const budgetModal        = document.getElementById("budget-modal");
  const openBudgetBtn      = document.getElementById("open-budget-modal");
  const closeBudgetBtn     = document.getElementById("close-budget-modal");

  const expenseModal       = document.getElementById("expense-modal");
  const openExpenseBtn     = document.getElementById("open-expense-modal");
  const closeExpenseBtn    = document.getElementById("close-expense-modal");

  const incomeModal        = document.getElementById("income-modal");
  const openIncomeBtn      = document.getElementById("open-income-modal");
  const closeIncomeBtn     = document.getElementById("close-income-modal");

  const incomeForm         = document.getElementById("income-form");

  const savingsModal       = document.getElementById("savings-modal");
  const openSavingsBtn     = document.getElementById("open-savings-modal");
  const closeSavingsBtn    = document.getElementById("close-savings-modal");
  
  // Savings

  if (openSavingsBtn && savingsModal) {
    openSavingsBtn.addEventListener("click", function () {
      savingsModal.classList.add("show");
    });
  }

  if (closeSavingsBtn && savingsModal) {
    closeSavingsBtn.addEventListener("click", function () {
      savingsModal.classList.remove("show");
    });
  }

  if (savingsModal) {
    savingsModal.addEventListener("click", function (event) {
      if (event.target === savingsModal) {
        savingsModal.classList.remove("show");
      }
    });
  }

  // ======================================================
  // 2. Open Income Modal
  // ======================================================
  if (openIncomeBtn && incomeModal) {
    openIncomeBtn.addEventListener("click", function () {
      incomeModal.classList.add("show");
    });
  }

  // Close income modal
  if (closeIncomeBtn && incomeModal) {
    closeIncomeBtn.addEventListener("click", function () {
      incomeModal.classList.remove("show");
    });
  }

  // Click outside income modal to close
  if (incomeModal) {
    incomeModal.addEventListener("click", function (event) {
      if (event.target === incomeModal) {
        incomeModal.classList.remove("show");
      }
    });
  }

  // ======================================================
  // 3. Open Expense Modal
  // ======================================================
  if (openExpenseBtn && expenseModal) {
    openExpenseBtn.addEventListener("click", function () {
      expenseModal.classList.add("show");
    });
  }



  // ======================================================
  // 4. åŸæœ¬çš„å¤§ Expense å¼¹çª—ï¼ˆå¦‚æœä½ ä»¥åè¿˜æƒ³ç›´æ¥ç”¨ï¼‰
  //    ç°åœ¨ä¸»è¦ç”±å°æŒ‰é’®æ§åˆ¶ï¼Œä½†ä¿ç•™å…³é—­é€»è¾‘
  // ======================================================

  // å…³é—­ expense å¼¹çª—
  if (closeExpenseBtn && expenseModal) {
    closeExpenseBtn.addEventListener("click", function () {
      expenseModal.classList.remove("show");
    });
  }

  // ç‚¹å‡» expense å¼¹çª—å¤–éƒ¨åŒºåŸŸ -> å…³é—­
  if (expenseModal) {
    expenseModal.addEventListener("click", function (event) {
      if (event.target === expenseModal) {
        expenseModal.classList.remove("show");
      }
    });
  }



  // ======================================================
  // 5. Expense è¡¨å•é‡Œï¼šåˆ†ç±»é€‰æ‹©é€»è¾‘ï¼ˆè€åŠŸèƒ½ä¿ç•™ï¼‰
  //    - é€‰æ‹©å·²æœ‰åˆ†ç±»
  //    - é€‰æ‹© "+ New category..." æ—¶å‡ºç°æ–°çš„è¾“å…¥æ¡†
  //    - æäº¤å‰æŠŠæœ€ç»ˆåˆ†ç±»å†™å…¥éšè—å­—æ®µ
  // ======================================================
  const expenseCategorySelect = document.getElementById("expense-category-select");
  const expenseNewCategory    = document.getElementById("expense-new-category-input");
  const expenseCategoryFinal  = document.getElementById("expense-category-final");
  const expenseForm           = document.getElementById("expense-form");

  if (expenseCategorySelect && expenseNewCategory) {
    expenseCategorySelect.addEventListener("change", function () {
      if (this.value === "__new__") {
        expenseNewCategory.style.display = "inline-block";
        expenseNewCategory.focus();
      } else {
        expenseNewCategory.style.display = "none";
        expenseNewCategory.value = "";
      }
    });
  }

  if (expenseForm) {
    expenseForm.addEventListener("submit", function (e) {
      let finalCategory = "";

      if (expenseCategorySelect) {
        if (expenseCategorySelect.value === "__new__") {
          finalCategory = (expenseNewCategory.value || "").trim();
        } else {
          finalCategory = expenseCategorySelect.value;
        }
      }

      if (!finalCategory) {
        e.preventDefault();
        alert("Please choose or enter a category.");
        return;
      }

      if (expenseCategoryFinal) {
        expenseCategoryFinal.value = finalCategory;
      }
    });
  }



  // ======================================================
  // 6. Budget å¼¹çª—ï¼šæ‰“å¼€ / å…³é—­é€»è¾‘
  // ======================================================
  function openBudgetModal() {
    if (budgetModal) {
      budgetModal.classList.add("show");
    }
  }

  function closeBudgetModal() {
    if (budgetModal) {
      budgetModal.classList.remove("show");
    }
  }

  if (openBudgetBtn) {
    openBudgetBtn.addEventListener("click", openBudgetModal);
  }

  if (closeBudgetBtn) {
    closeBudgetBtn.addEventListener("click", closeBudgetModal);
  }

  if (budgetModal) {
    budgetModal.addEventListener("click", function (event) {
      if (event.target === budgetModal) {
        closeBudgetModal();
      }
    });
  }



  // ======================================================
  // 7. Budget é¢„ç®—è¡¨ï¼šå‰ç«¯å­˜å‚¨ + ä»åç«¯åˆå§‹è½½å…¥
  //    - categories æ•°ç»„ä¿å­˜æ‰€æœ‰ {category, amount}
  //    - initialCategoryBudgets ä» plan.category_budgets æ³¨å…¥
  // ======================================================
  const categorySelect      = document.getElementById("category-select");
  const newCategoryInput    = document.getElementById("new-category-input");
  const categoryAmountInput = document.getElementById("category-amount-input");
  const addCategoryBtn      = document.getElementById("add-category-btn");
  const categoryTableBody   = document.querySelector("#category-table tbody");
  const totalBudgetInput    = document.getElementById("total-budget-input");
  const categoriesJsonInput = document.getElementById("categories-json");
  const budgetForm          = document.getElementById("budget-form");

  let categories           = [];
  let totalEditedManually  = false;
  let editingIndex         = null;

  // ä»åç«¯è¯»å–åˆå§‹ category_budgetsï¼ˆJinja æ³¨å…¥ï¼‰
  const initialCategoryBudgets = {{ (plan.category_budgets if plan and plan.get('category_budgets') else {}) | tojson }};

  for (const [name, amount] of Object.entries(initialCategoryBudgets)) {
    categories.push({
      category: name,
      amount: Number(amount) || 0
    });
  }



  // ======================================================
  // 8. Budgetï¼šä¸‹æ‹‰æ¡† "New" æ—¶æ˜¾ç¤ºæ–°åˆ†ç±»è¾“å…¥æ¡†
  // ======================================================
  if (categorySelect && newCategoryInput) {
    categorySelect.addEventListener("change", function () {
      if (this.value === "New") {
        newCategoryInput.style.display = "inline-block";
        newCategoryInput.focus();
      } else {
        newCategoryInput.style.display = "none";
      }
    });
  }



  // ======================================================
  // 9. Budgetï¼šæ·»åŠ  / ç¼–è¾‘ åˆ†ç±»
  //    - ç‚¹å‡» Add to plan
  //    - editingIndex != null è¡¨ç¤ºå½“å‰åœ¨ç¼–è¾‘æŸä¸€è¡Œ
  // ======================================================
  if (addCategoryBtn) {
    addCategoryBtn.addEventListener("click", function () {
      const amountValue = parseFloat(categoryAmountInput.value);

      if (isNaN(amountValue) || amountValue <= 0) {
        alert("Please enter a valid positive amount.");
        return;
      }

      let categoryName = null;

      if (editingIndex !== null) {
        // ç¼–è¾‘æ¨¡å¼ï¼šå…è®¸ä¿®æ”¹åˆ†ç±»å
        if (categorySelect.value === "New") {
          categoryName = newCategoryInput.value.trim();
        } else if (categorySelect.value) {
          categoryName = categorySelect.value;
        } else {
          categoryName = categories[editingIndex].category;
        }

        if (!categoryName) {
          alert("Please choose or enter a category name.");
          return;
        }

        categories[editingIndex] = {
          category: categoryName,
          amount: amountValue
        };
        editingIndex = null;  // é€€å‡ºç¼–è¾‘æ¨¡å¼

      } else {
        // æ–°å¢æ¨¡å¼
        if (categorySelect.value === "New") {
          categoryName = newCategoryInput.value.trim();
        } else {
          categoryName = categorySelect.value;
        }

        if (!categoryName) {
          alert("Please choose or enter a category name.");
          return;
        }

        const existing = categories.find(c => c.category === categoryName);
        if (existing) {
          existing.amount = amountValue;
        } else {
          categories.push({ category: categoryName, amount: amountValue });
        }
      }

      // æ¸…ç©ºè¾“å…¥åŒºåŸŸ
      categoryAmountInput.value = "";
      if (categorySelect) categorySelect.value = "";
      if (newCategoryInput) {
        newCategoryInput.value = "";
        newCategoryInput.style.display = "none";
      }

      renderCategoryTable();
      updateTotalIfNotEdited();
    });
  }



  // ======================================================
  // 10. Budgetï¼šæ¸²æŸ“åˆ†ç±»è¡¨æ ¼ + ç¼–è¾‘ / åˆ é™¤ æŒ‰é’®
  // ======================================================
  function renderCategoryTable() {
    if (!categoryTableBody) return;

    categoryTableBody.innerHTML = "";

    categories.forEach((item, index) => {
      const tr = document.createElement("tr");

      const tdName = document.createElement("td");
      tdName.textContent = item.category;

      const tdAmount = document.createElement("td");
      tdAmount.textContent = item.amount.toFixed(2);

      tr.appendChild(tdName);
      tr.appendChild(tdAmount);

      {% if can_edit_budget %}
      // ---- Actions: Edit / Delete ----
      const tdActions = document.createElement("td");

      // Edit æŒ‰é’®
      const editBtn = document.createElement("button");
      editBtn.type = "button";
      editBtn.className = "icon-button edit-btn";

      const editImg = document.createElement("img");
      editImg.src = "{{ url_for('static', filename='edit.png') }}";
      editImg.alt = "Edit";
      editBtn.appendChild(editImg);

      editBtn.addEventListener("click", function () {
        editingIndex = index;

        if (categoryAmountInput) {
          categoryAmountInput.value = item.amount.toFixed(2);
        }

        if (categorySelect && newCategoryInput) {
          const values = Array.from(categorySelect.options).map(o => o.value);
          if (values.includes(item.category)) {
            categorySelect.value = item.category;
            newCategoryInput.value = "";
            newCategoryInput.style.display = "none";
          } else {
            categorySelect.value = "New";
            newCategoryInput.value = item.category;
            newCategoryInput.style.display = "inline-block";
          }
        }
      });

      // Delete æŒ‰é’®
      const deleteBtn = document.createElement("button");
      deleteBtn.type = "button";
      deleteBtn.className = "icon-button delete-btn";

      const deleteImg = document.createElement("img");
      deleteImg.src = "{{ url_for('static', filename='delete.png') }}";
      deleteImg.alt = "Delete";
      deleteBtn.appendChild(deleteImg);

      deleteBtn.addEventListener("click", function () {
        categories.splice(index, 1);

        if (editingIndex === index) {
          editingIndex = null;
          if (categoryAmountInput) categoryAmountInput.value = "";
        }

        totalEditedManually = false;
        renderCategoryTable();
        updateTotalIfNotEdited();
      });

      tdActions.appendChild(editBtn);
      tdActions.appendChild(deleteBtn);
      tr.appendChild(tdActions);
      {% endif %}

      categoryTableBody.appendChild(tr);
    });
  }



  // ======================================================
  // 11. Budgetï¼šåˆè®¡ total_budget çš„é€»è¾‘
  //      - é»˜è®¤è‡ªåŠ¨ = æ‰€æœ‰åˆ†ç±»é‡‘é¢ä¹‹å’Œ
  //      - ç”¨æˆ·æ‰‹åŠ¨æ”¹ total æ—¶ï¼Œå…è®¸å¤šå‡ºçš„éƒ¨åˆ†ä½œä¸º "extra"
  // ======================================================
  function getCategoriesSum() {
    return categories.reduce((sum, c) => sum + (c.amount || 0), 0);
  }

  function updateTotalIfNotEdited() {
    if (!totalEditedManually && totalBudgetInput) {
      const sum = getCategoriesSum();
      if (sum > 0) {
        totalBudgetInput.value = sum.toFixed(2);
      }
    }
  }

  if (totalBudgetInput) {
    totalBudgetInput.addEventListener("focus", function () {
      totalEditedManually = true;
    });

    totalBudgetInput.addEventListener("blur", function () {
      const manualTotal = parseFloat(totalBudgetInput.value);
      const sum = getCategoriesSum();

      if (!isNaN(manualTotal) && manualTotal > sum) {
        const extraAmount = manualTotal - sum;
        const existingExtra = categories.find(c => c.category === "extra");
        if (existingExtra) {
          existingExtra.amount += extraAmount;
        } else {
          categories.push({ category: "extra", amount: extraAmount });
        }
        renderCategoryTable();
      }
    });
  }



  // ======================================================
  // 12. Budgetï¼šè¡¨å•æäº¤æ—¶ï¼ŒæŠŠ categories å†™å…¥éšè—å­—æ®µ
  // ======================================================
  if (budgetForm) {
    budgetForm.addEventListener("submit", function () {
      if (categoriesJsonInput) {
        categoriesJsonInput.value = JSON.stringify(categories);
      }
    });
  }



  // ======================================================
  // 13. é¡µé¢åŠ è½½å®Œæˆåï¼šæŠŠå·²æœ‰é¢„ç®—æ¸²æŸ“å‡ºæ¥
  // ======================================================
  renderCategoryTable();
  updateTotalIfNotEdited();

  // ======================================================
  // 14. render expense pie chart (relative to total budget)
  // ======================================================
  const expensePieCanvas = document.getElementById('expense-pie-chart');
  
  if (expensePieCanvas) {
    const expenseData = {
      {% for category, amount in expense_by_category.items() %}
      "{{ category }}": {{ amount }},
      {% endfor %}
    };
    
    const totalBudget = {{ plan.total_budget if plan else 0 }};
    const categories = Object.keys(expenseData);
    const amounts = Object.values(expenseData);
    const totalSpent = amounts.reduce((a, b) => a + b, 0);
    const remainingBudget = totalBudget - totalSpent;
    
    // Add remaining budget to the chart if there is any
    const chartLabels = [...categories];
    const chartData = [...amounts];
    const colors = [
      '#6366f1', '#ec4899', '#10b981', '#f59e0b',
      '#8b5cf6', '#06b6d4', '#f43f5e', '#14b8a6',
      '#a855f7', '#84cc16', '#f97316', '#3b82f6'
    ];
    const chartColors = colors.slice(0, categories.length);
    
    if (remainingBudget > 0) {
      chartLabels.push('Remaining Budget');
      chartData.push(remainingBudget);
      chartColors.push('#e5e7eb'); // Gray color for remaining
    }
    
    const ctx = expensePieCanvas.getContext('2d');
    new Chart(ctx, {
      type: 'pie',
      data: {
        labels: chartLabels,
        datasets: [{
          data: chartData,
          backgroundColor: chartColors,
          borderColor: '#ffffff',
          borderWidth: 3,
          hoverOffset: 15
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: true,
        plugins: {
          legend: {
            position: 'bottom',
            labels: {
              padding: 15,
              font: { size: 12 },
              generateLabels: function(chart) {
                const data = chart.data;
                return data.labels.map((label, i) => {
                  const value = data.datasets[0].data[i];
                  const percentage = totalBudget > 0 ? ((value / totalBudget) * 100).toFixed(1) : 0;
                  return {
                    text: `${label}: $${value.toFixed(2)} (${percentage}% of budget)`,
                    fillStyle: data.datasets[0].backgroundColor[i],
                    hidden: false,
                    index: i
                  };
                });
              }
            }
          },
          tooltip: {
            backgroundColor: 'rgba(0, 0, 0, 0.8)',
            padding: 12,
            callbacks: {
              label: function(context) {
                const value = context.parsed;
                const percentage = totalBudget > 0 ? ((value / totalBudget) * 100).toFixed(1) : 0;
                return `$${value.toFixed(2)} (${percentage}% of budget)`;
              }
            }
          }
        },
        animation: {
          animateRotate: true,
          animateScale: true,
          duration: 1000
        }
      }
    });
  }

  // ======================================================
  // 15. render income capacity tracker chart
  // ======================================================
  const incomeCapacityCanvas = document.getElementById('income-capacity-chart');
  
  if (incomeCapacityCanvas) {
    {% set total_budget = plan.total_budget if plan else 0 %}
    {% set total_spent = expense_by_category.values()|sum %}
    {% set remaining_budget = total_budget - total_spent %}
    {% set savings = total_income - total_budget %}
    
    const totalIncome = {{ total_income }};
    const totalBudget = {{ total_budget }};
    const totalSpent = {{ total_spent }};
    const remainingBudget = {{ remaining_budget if remaining_budget > 0 else 0 }};
    const savings = {{ savings }};
    
    const ctx = incomeCapacityCanvas.getContext('2d');
    new Chart(ctx, {
      type: 'bar',
      data: {
        labels: ['Financial Overview'],
        datasets: [
          {
            label: 'Actual Expenses',
            data: [totalSpent],
            backgroundColor: '#ec4899',
            borderColor: '#ffffff',
            borderWidth: 2
          },
          {
            label: 'Remaining Budget',
            data: [remainingBudget],
            backgroundColor: '#6366f1',
            borderColor: '#ffffff',
            borderWidth: 2
          },
          {
            label: 'Savings/Buffer',
            data: [savings > 0 ? savings : 0],
            backgroundColor: savings > 0 ? '#10b981' : '#ef4444',
            borderColor: '#ffffff',
            borderWidth: 2
          }
        ]
      },
      options: {
        indexAxis: 'y',
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          x: {
            stacked: true,
            beginAtZero: true,
            max: totalIncome > 0 ? totalIncome * 1.1 : 100,
            title: {
              display: true,
              text: 'Amount ($)',
              font: { size: 14, weight: 'bold' }
            },
            grid: {
              color: 'rgba(0, 0, 0, 0.1)'
            }
          },
          y: {
            stacked: true,
            display: false
          }
        },
        plugins: {
          legend: {
            display: true,
            position: 'bottom',
            labels: {
              padding: 15,
              font: { size: 12 },
              usePointStyle: true
            }
          },
          tooltip: {
            backgroundColor: 'rgba(0, 0, 0, 0.8)',
            padding: 12,
            titleFont: { size: 14, weight: 'bold' },
            bodyFont: { size: 13 },
            callbacks: {
              label: function(context) {
                const label = context.dataset.label || '';
                const value = context.parsed.x || 0;
                const percentage = totalIncome > 0 ? ((value / totalIncome) * 100).toFixed(1) : 0;
                return `${label}: $${value.toFixed(2)} (${percentage}% of income)`;
              },
              afterBody: function(context) {
                if (context.length > 0) {
                  return `\nTotal Income: $${totalIncome.toFixed(2)}`;
                }
              }
            }
          }
        },
        animation: {
          duration: 1000,
          easing: 'easeInOutQuart'
        }
      }
    });
  }

  // ======================================================
  // 16. AI Modal
  // ======================================================
  const aiModal = document.getElementById("ai-modal");
  const openAiBtn = document.getElementById("open-ai-modal");
  const closeAiBtn = document.getElementById("close-ai-modal");
  const aiForm = document.getElementById("ai-form");
  const aiQuestion = document.getElementById("ai-question");
  const aiConversation = document.getElementById("ai-conversation");
  const aiSubmitBtn = document.getElementById("ai-submit-btn");

  if (openAiBtn && aiModal) {
    openAiBtn.addEventListener("click", function () {
      aiModal.classList.add("show");
    });
  }

  if (closeAiBtn && aiModal) {
    closeAiBtn.addEventListener("click", function () {
      aiModal.classList.remove("show");
    });
  }

  if (aiModal) {
    aiModal.addEventListener("click", function (event) {
      if (event.target === aiModal) {
        aiModal.classList.remove("show");
      }
    });
  }

  if (aiForm) {
    aiForm.addEventListener("submit", async function (e) {
      e.preventDefault();
      
      const question = aiQuestion.value.trim();
      if (!question) return;
      
      // Show loading state
      aiSubmitBtn.disabled = true;
      aiSubmitBtn.querySelector('.btn-text').style.display = 'none';
      aiSubmitBtn.querySelector('.btn-loading').style.display = 'inline';
      
      // Add user question to conversation
      const userMsg = document.createElement('div');
      userMsg.className = 'ai-message user-message';
      userMsg.textContent = question;
      aiConversation.appendChild(userMsg);
      
      try {
        const response = await fetch('/ai/advice', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ question })
        });
        
        const data = await response.json();
        
        if (response.ok) {
          // Add AI response to conversation
          const aiMsg = document.createElement('div');
          aiMsg.className = 'ai-message ai-response';
          aiMsg.textContent = data.advice;
          aiConversation.appendChild(aiMsg);
          
          // Scroll to bottom
          aiConversation.scrollTop = aiConversation.scrollHeight;
          
          // Clear input
          aiQuestion.value = '';
        } else {
          alert('Error: ' + (data.error || 'Failed to get advice'));
        }
      } catch (error) {
        alert('Error connecting to AI service: ' + error.message);
      } finally {
        // Reset button state
        aiSubmitBtn.disabled = false;
        aiSubmitBtn.querySelector('.btn-text').style.display = 'inline';
        aiSubmitBtn.querySelector('.btn-loading').style.display = 'none';
      }
    });
  }

  // ======================================================
  // 17. Search Modal
  // ======================================================
  const searchModal = document.getElementById("search-modal");
  const openSearchBtn = document.getElementById("open-search-modal");
  const closeSearchBtn = document.getElementById("close-search-modal");
  const searchBtn = document.getElementById("search-btn");
  const clearSearchBtn = document.getElementById("clear-search-btn");
  const searchInput = document.getElementById("search-input");
  const searchDateFrom = document.getElementById("search-date-from");
  const searchDateTo = document.getElementById("search-date-to");
  const searchCategory = document.getElementById("search-category");
  const expensesTableBody = document.getElementById("expenses-table-body");

  // Store all expenses for filtering
  const allExpenses = [
    {% for e in expenses %}
    {
      date: "{{ e.date.strftime('%Y-%m-%d') if e.date else '' }}",
      category: "{{ e.category }}",
      amount: {{ e.amount }},
      note: "{{ e.note if e.note else '' }}",
      id: "{{ e._id }}"
    },
    {% endfor %}
  ];

  if (openSearchBtn && searchModal) {
    openSearchBtn.addEventListener("click", function () {
      searchModal.classList.add("show");
    });
  }

  if (closeSearchBtn && searchModal) {
    closeSearchBtn.addEventListener("click", function () {
      searchModal.classList.remove("show");
    });
  }

  if (searchModal) {
    searchModal.addEventListener("click", function (event) {
      if (event.target === searchModal) {
        searchModal.classList.remove("show");
      }
    });
  }

  // Search function
  function performSearch() {
    const searchTerm = searchInput.value.toLowerCase();
    const dateFrom = searchDateFrom.value;
    const dateTo = searchDateTo.value;
    const categoryFilter = searchCategory.value;

    const filtered = allExpenses.filter(expense => {
      // Text search (category, amount, or note)
      const matchesText = !searchTerm || 
        expense.category.toLowerCase().includes(searchTerm) ||
        expense.amount.toString().includes(searchTerm) ||
        expense.note.toLowerCase().includes(searchTerm);

      // Date range filter
      const matchesDateFrom = !dateFrom || expense.date >= dateFrom;
      const matchesDateTo = !dateTo || expense.date <= dateTo;

      // Category filter
      const matchesCategory = !categoryFilter || expense.category === categoryFilter;

      return matchesText && matchesDateFrom && matchesDateTo && matchesCategory;
    });

    // Update table with filtered results
    expensesTableBody.innerHTML = '';
    filtered.forEach(expense => {
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${expense.date}</td>
        <td>${expense.category}</td>
        <td>$${expense.amount.toFixed(2)}</td>
        <td class="note-cell">${expense.note || '-'}</td>
        <td>
          <form method="POST" action="/expenses/delete/${expense.id}" style="display: inline;" onsubmit="return confirm('Delete this expense?');">
            <button type="submit" class="icon-button delete-btn">
              <img src="{{ url_for('static', filename='delete.png') }}" alt="Delete">
            </button>
          </form>
        </td>
      `;
      expensesTableBody.appendChild(row);
    });

    // Show count in modal
    const resultsDiv = document.getElementById('search-results');
    resultsDiv.innerHTML = `<p style="color: var(--text-secondary); font-style: italic;">Found ${filtered.length} expense(s)</p>`;
  }

  if (searchBtn) {
    searchBtn.addEventListener("click", performSearch);
  }

  // Clear filters
  if (clearSearchBtn) {
    clearSearchBtn.addEventListener("click", function () {
      searchInput.value = '';
      searchDateFrom.value = '';
      searchDateTo.value = '';
      searchCategory.value = '';
      
      // Reset table to show all expenses
      expensesTableBody.innerHTML = '';
      allExpenses.forEach(expense => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${expense.date}</td>
          <td>${expense.category}</td>
          <td>$${expense.amount.toFixed(2)}</td>
          <td class="note-cell">${expense.note || '-'}</td>
          <td>
            <form method="POST" action="/expenses/delete/${expense.id}" style="display: inline;" onsubmit="return confirm('Delete this expense?');">
              <button type="submit" class="icon-button delete-btn">
                <img src="{{ url_for('static', filename='delete.png') }}" alt="Delete">
              </button>
            </form>
          </td>
        `;
        expensesTableBody.appendChild(row);
      });
      
      document.getElementById('search-results').innerHTML = '';
    });
  }

  // Real-time search on input
  if (searchInput) {
    searchInput.addEventListener("input", function () {
      if (searchInput.value.length > 0) {
        performSearch();
      }
    });
  }

});
</script>


{% endblock %}
